<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Subathon Overlay</title>
<style>
  html, body { background: transparent; }
  body{font-family: 'Inter', system-ui, Arial; color:#e8f0fb; margin:0; padding:20px}
  .wrap{display:flex;gap:20px;align-items:flex-start}
  .ticker{
    background: rgba(0,0,0,0.0);
    border-radius: 16px;
    padding: 10px 14px;
    display:inline-flex;
    align-items:center;
    backdrop-filter: blur(0px);
  }
  /* Big transparent digits (TikFinity vibe) */
  .digits{
    font-weight: 900;
    font-size: 120px;
    letter-spacing: 2px;
    line-height: 1;
    color: #ffffff;
    text-shadow: 0 0 12px rgba(0,0,0,.35);
  }
  .muted{opacity:.85; font-weight:600; margin-top:8px}
  .bar{height:12px;background:rgba(255,255,255,.12);border-radius:12px;overflow:hidden;margin:12px 0 6px; width: 520px}
  .fill{height:100%;width:0%}
  .fill::before{
    content:""; display:block; height:100%; width:100%;
  }
  /* gradient through CSS variable so OBS color key keeps transparency intact */
  .fill{ background: linear-gradient(90deg,#27d7ff,#43ff7b); }

  .panel{
    background: rgba(10,12,16,.55);
    border:1px solid rgba(255,255,255,.08);
    border-radius: 16px;
    padding: 12px;
    width: 360px;
  }
  .row{display:flex;gap:10px;margin-top:10px}
  .btn{flex:1;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
       border-radius:12px;color:#e8f0fb;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(1.12)}
  .input{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);
         border-radius:12px;color:#e8f0fb;padding:10px 12px; outline:none}
  label{font-size:12px;opacity:.8}
</style>
</head>
<body>
  <div class="wrap">
    <div>
      <div class="ticker">
        <div class="digits" id="clock">00:00:00</div>
      </div>
      <div class="muted" id="status">Listo.</div>
      <div class="bar"><div class="fill" id="fill"></div></div>
      <div class="row">
        <button class="btn" id="add">+10s</button>
        <button class="btn" id="sub">-10s</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="gap:6px; align-items: end;">
        <div style="flex:1">
          <label>TikTok user</label>
          <input class="input" id="tikuser" placeholder="ej. TuUsuarioTikTok">
        </div>
        <button class="btn" id="btnTik">Conectar</button>
      </div>
      <div class="row" style="gap:6px; align-items: end;">
        <div style="flex:1">
          <label>Kick canal</label>
          <input class="input" id="kickch" placeholder="ej. TuCanalKick">
        </div>
        <button class="btn" id="btnKick">Conectar</button>
      </div>
      <div class="row">
        <button class="btn" id="saveCfg">Guardar / Aplicar</button>
      </div>
    </div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);
  const defaultWs = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
  const wsUrl = qs.get('ws') || defaultWs;
  const ws = new WebSocket(wsUrl);

  let remaining = 0, maxSeconds = 3600, manualStep = 10;

  function fmt(s){
    s = Math.max(0, Math.floor(s));
    const h = String(Math.floor(s/3600)).padStart(2,'0');
    const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const sec = String(s%60).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }
  function draw(){
    document.getElementById('clock').textContent = fmt(remaining);
    const pct = Math.min(100, Math.max(0, 100*remaining/maxSeconds));
    document.getElementById('fill').style.width = pct+'%';
  }
  setInterval(()=>{ remaining = Math.max(0, remaining-1); draw(); }, 1000);

  ws.onmessage = (ev)=>{
    const {type, payload} = JSON.parse(ev.data);
    if (type==='init'){
      remaining = payload.remaining; maxSeconds = payload.rules.maxSeconds; manualStep = payload.rules.manualStep; draw();
      if (payload.tiktokUser) document.getElementById('tikuser').value = payload.tiktokUser;
      if (payload.kickChannel) document.getElementById('kickch').value = payload.kickChannel;
    }
    if (type==='timer'){ remaining = payload.remaining; draw(); }
    if (type==='event'){ document.getElementById('status').textContent = `+${payload.add}s • ${payload.platform} • ${payload.type}`; }
    if (type==='config:applied'){ document.getElementById('status').textContent = `Config aplicada ✓ TikTok:${payload.tiktokUser||'-'} Kick:${payload.kickChannel||'-'}`; }
  };

  // transparency: in OBS Browser Source, enable "Allow transparency"
  document.getElementById('add').onclick = ()=> ws.send(JSON.stringify({type:'manual:add', payload:{seconds:manualStep}}));
  document.getElementById('sub').onclick = ()=> ws.send(JSON.stringify({type:'manual:sub', payload:{seconds:manualStep}}));

  document.getElementById('btnTik').onclick = ()=> ws.send(JSON.stringify({type:'config:update', payload:{tiktokUser: document.getElementById('tikuser').value}}));
  document.getElementById('btnKick').onclick = ()=> ws.send(JSON.stringify({type:'config:update', payload:{kickChannel: document.getElementById('kickch').value}}));
  document.getElementById('saveCfg').onclick = ()=> ws.send(JSON.stringify({type:'config:update', payload:{
    tiktokUser: document.getElementById('tikuser').value,
    kickChannel: document.getElementById('kickch').value
  }}));
</script>
</body>
</html>